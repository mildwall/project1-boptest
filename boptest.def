Bootstrap: docker
From: --platform=linux/x86_64 ubuntu:20.04

%post
    # Update and install required packages
    apt-get update && \
    apt-get install -y \
        wget \
        libgfortran4 && \
    rm -rf /var/lib/apt/lists/*

    # Install Spawn
    SPAWN_VERSION=0.3.0-8d93151657
    wget https://spawn.s3.amazonaws.com/custom/Spawn-$SPAWN_VERSION-Linux.tar.gz && \
    tar -xzf Spawn-$SPAWN_VERSION-Linux.tar.gz && \
    ln -s /Spawn-$SPAWN_VERSION-Linux/bin/spawn-$SPAWN_VERSION /usr/local/bin/ && \
    rm Spawn-$SPAWN_VERSION-Linux.tar.gz

    # Create new user
    useradd -ms /bin/bash user
    mkdir -p /home/user
    chown user:user /home/user

    # Install Miniconda and required Python packages
    su user -c "cd /home/user && \
        wget https://repo.anaconda.com/miniconda/Miniconda3-py310_23.1.0-1-Linux-x86_64.sh -O /home/user/miniconda.sh && \
        /bin/bash /home/user/miniconda.sh -b -p /home/user/miniconda && \
        . /home/user/miniconda/bin/activate && \
        conda update -n base -c defaults conda && \
        conda create --name pyfmi3 python=3.10 -y && \
        conda activate pyfmi3 && \
        conda install -c conda-forge pyfmi=2.11 -y && \
        pip install flask-restful==0.3.9 werkzeug==2.2.3 pandas==1.5.3 flask_cors==3.0.10 scipy==1.13.0 matplotlib==3.7.1 requests==2.28.1 && \
        mkdir models && mkdir doc"

%environment
    export HOME=/home/user
    export PATH=$HOME/miniconda/bin:$PATH
    export PYTHONPATH=$PYTHONPATH:$HOME
    export BOPTEST_DASHBOARD_SERVER=https://dashboard.boptest.net/

%startscript
    . /home/user/miniconda/bin/activate && conda activate pyfmi3 && python /home/user/restapi.py && bash

%runscript
    exec /bin/bash
